# Tempus - 実装計画

## 実装方針

### 基本原則
1. **機能単位で実装**: 各フェーズで完結した機能を実装
2. **段階的な開発**: 基礎→応用の順で実装
3. **テスト可能性**: 各フェーズで動作確認可能な状態を保つ
4. **依存関係の考慮**: 前のフェーズが次のフェーズの基盤となる

---

## フェーズ1: 基盤構築
**目標**: データベース・基本APIの構築

### タスク
1. **Prismaセットアップ**
   - Prismaのインストール
   - `schema.prisma` の作成（recordsテーブル定義）
   - マイグレーション実行
   - Prismaクライアントのセットアップ

2. **ユーティリティ関数の実装**
   - 日時計算関数（1日の定義: 6:00-6:00）
   - 勤務時間計算関数
   - 型定義ファイルの作成

3. **Basic認証ミドルウェア**
   - 環境変数からクレデンシャル読み込み
   - Basic認証チェック関数
   - API Routesへの適用

### 完了条件
- [ ] データベースが作成され、テーブルが存在する
- [ ] Prismaクライアントでデータベースにアクセスできる
- [ ] Basic認証が動作する

---

## フェーズ2: 基本打刻機能（Web）
**目標**: Webから打刻できる最小機能を実装

### タスク
1. **API実装**
   - `POST /api/clock` - 打刻記録API
   - `GET /api/status` - 現在の状態取得API

2. **フロントエンド実装**
   - `ClockButton` コンポーネント - 打刻ボタン
   - `StatusDisplay` コンポーネント - 現在の状態表示
   - メインページの基本レイアウト

3. **自動判定ロジック**
   - 最新レコードから出勤/退勤を判定
   - ボタンテキストの動的変更（「出勤する」/「退勤する」）

### 完了条件
- [ ] Webから打刻ボタンを押すと記録される
- [ ] 出勤→退勤→出勤と正しく切り替わる
- [ ] 現在の状態（出勤中/退勤済み）が表示される

---

## フェーズ3: 履歴表示機能
**目標**: 打刻履歴を月単位で表示

### タスク
1. **API実装**
   - `GET /api/records` - 月次履歴取得API
   - 月の範囲計算（6:00-6:00基準）
   - 退勤未打刻の検出ロジック

2. **フロントエンド実装**
   - `RecordsList` コンポーネント - 履歴一覧
   - `RecordItem` コンポーネント - 個別レコード表示
   - 月切り替えUI（前月/次月ボタン）
   - `AlertBanner` コンポーネント - 退勤未打刻アラート

3. **データ表示**
   - 日時フォーマット
   - 打刻種類の表示（出勤/退勤）
   - 打刻元の表示（Web/Discord）

### 完了条件
- [ ] 当月の打刻履歴が一覧表示される
- [ ] 月を切り替えて過去の履歴を見られる
- [ ] 退勤未打刻の日にアラートが表示される

---

## フェーズ4: 月次集計機能
**目標**: 勤務時間と勤務日数を集計表示

### タスク
1. **集計ロジック実装**
   - 出勤/退勤のペアリング
   - 勤務時間の計算（時間:分形式）
   - 勤務日数のカウント
   - 退勤未打刻日のリストアップ

2. **API拡張**
   - `GET /api/records` のレスポンスに統計情報を追加

3. **フロントエンド実装**
   - `MonthlyStats` コンポーネント - 月次集計表示
   - 総勤務時間の表示（HH:MM形式）
   - 勤務日数の表示

### 完了条件
- [ ] 月次集計エリアが表示される
- [ ] 総勤務時間が正しく計算される（例: 160:30）
- [ ] 勤務日数が正しくカウントされる
- [ ] 退勤未打刻の日は集計から除外される

---

## フェーズ5: 編集・削除機能
**目標**: 打刻レコードの編集・削除・過去打刻追加

### タスク
1. **API実装**
   - `PUT /api/records/[id]` - レコード編集API
   - `DELETE /api/records/[id]` - レコード削除API
   - 編集フラグの自動設定

2. **フロントエンド実装**
   - `EditModal` コンポーネント - 編集モーダル
   - 日時入力フィールド
   - コメント入力フィールド
   - 確認ダイアログ（削除時）

3. **視覚的な区別**
   - 編集済みレコードのスタイリング
   - 編集マークの表示
   - コメントの表示

4. **過去打刻の追加**
   - 新規レコード追加UI
   - 日時指定機能
   - 自動的に `is_edited: true` として記録

### 完了条件
- [ ] 既存の打刻を編集できる
- [ ] 打刻を削除できる（確認ダイアログ付き）
- [ ] 過去の日時で打刻を追加できる
- [ ] 編集済みレコードが視覚的に区別される
- [ ] 編集コメントが表示される

---

## フェーズ6: Discord Bot基本機能
**目標**: Discordから打刻できるようにする

### タスク
1. **Discord Botセットアップ**
   - discord.js のインストール
   - Bot初期化コード
   - 環境変数からトークン読み込み

2. **スラッシュコマンド実装**
   - `/tempus` コマンドの登録
   - コマンド実行時の処理
   - Discord IDによる認証

3. **API連携**
   - BotからNext.js APIへのHTTPリクエスト
   - `POST /api/clock` への送信（source: 'discord'）
   - エラーハンドリング

4. **レスポンス実装**
   - 打刻成功時の返信メッセージ
   - エラー時の返信メッセージ

### 完了条件
- [ ] Discord Botが起動する
- [ ] `/tempus` コマンドが実行できる
- [ ] Discord IDで本人確認される
- [ ] Discordから打刻するとDBに記録される
- [ ] 実行結果が返信される

---

## フェーズ7: Discord通知機能
**目標**: Webからの打刻をDiscordに通知

### タスク
1. **通知機能実装**
   - Discord通知用のユーティリティ関数
   - Embedメッセージの作成
   - チャンネルへのメッセージ送信

2. **API拡張**
   - `POST /api/clock` から通知を送信
   - エラー時の適切なハンドリング

3. **通知内容の設計**
   - 打刻種類（出勤/退勤）
   - 打刻時刻
   - 視覚的にわかりやすいEmbedデザイン

### 完了条件
- [ ] Webから打刻するとDiscordに通知される
- [ ] Discordから打刻すると確認メッセージが表示される
- [ ] 通知内容がわかりやすい
- [ ] 通知エラー時もWeb打刻は成功する

---

## フェーズ8: UI/UX改善
**目標**: 使いやすさとデザインの向上

### タスク
1. **デザイン改善**
   - 全体的なスタイリング
   - レスポンシブ対応（オプション）
   - ローディング状態の表示
   - トーストメッセージ（成功/エラー通知）

2. **エラーハンドリング強化**
   - ネットワークエラー時の表示
   - バリデーションエラーの表示
   - ユーザーフレンドリーなエラーメッセージ

3. **パフォーマンス最適化**
   - データ取得の最適化
   - 不要な再レンダリングの削減

### 完了条件
- [ ] 全体的なデザインが整っている
- [ ] ローディング中の表示がある
- [ ] エラーが適切に表示される
- [ ] 操作がスムーズ

---

## フェーズ9: デプロイ準備
**目標**: 本番環境へのデプロイ

### タスク
1. **環境変数の整理**
   - `.env.example` の作成
   - 必須環境変数のドキュメント化

2. **デプロイ設定**
   - Vercel / Railway の設定ファイル
   - データベースの永続化設定
   - Discord Botの常時起動設定

3. **ドキュメント整備**
   - README.mdの更新
   - セットアップ手順の記載
   - トラブルシューティングガイド

### 完了条件
- [ ] 本番環境にデプロイできる
- [ ] データベースが永続化される
- [ ] Discord Botが常時起動する
- [ ] ドキュメントが整っている

---

## 推奨実装順序

```
フェーズ1（基盤構築）
    ↓
フェーズ2（基本打刻機能）
    ↓
フェーズ3（履歴表示）
    ↓
フェーズ4（月次集計）
    ↓
フェーズ5（編集・削除）
    ↓
フェーズ6（Discord Bot基本）
    ↓
フェーズ7（Discord通知）
    ↓
フェーズ8（UI/UX改善）
    ↓
フェーズ9（デプロイ）
```

---

## 各フェーズの想定工数

| フェーズ | 内容 | 想定時間 |
|---------|------|----------|
| 1 | 基盤構築 | 1-2時間 |
| 2 | 基本打刻機能 | 2-3時間 |
| 3 | 履歴表示 | 2-3時間 |
| 4 | 月次集計 | 1-2時間 |
| 5 | 編集・削除 | 3-4時間 |
| 6 | Discord Bot基本 | 2-3時間 |
| 7 | Discord通知 | 1-2時間 |
| 8 | UI/UX改善 | 2-4時間 |
| 9 | デプロイ | 1-2時間 |

**合計**: 15-25時間程度

---

## 次のアクション

**フェーズ1: 基盤構築** から開始します。
準備ができたら教えてください！
